<script>
  document.getElementsByTagName('title')[0].innerHTML = 'treeTest'

  /* Test de tree*/
  // No funciona
</script>

    <style>
        .edit-button:before {
            content: var(--icon-edit);
            padding-right: 5px;
        }

        .edit-button {
            font-family: var(--icon-font);
            font-style: normal;
            color: var(--pallette-color-secondary-1-0);
            cursor: pointer;
        }

        .edit-button:hover {
            color: var(--pallette-color-secondary-1-1);
        }
    </style>


<div style="display:none">
    <!-- Widget base -->
    <div data-sivWidget="Siviglia.Widgets.Lists.Tree" data-widgetCode="Siviglia.Widgets.Lists.Tree">
        <div data-sivId="containerNode"></div>
    </div>


    <!-- Widget derivado -->
    <div data-sivWidget="Siviglia.Widgets.Lists.ReflectionTree" data-widgetCode="Siviglia.Widgets.Lists.ReflectionTree">
        <div data-sivId="containerNode"></div>
    </div>
</div>

<div data-sivView="Siviglia.Widgets.Lists.ReflectionTree"></div>


<script>
  var theData = [{
    "resource": "Package",
    "name": "ads",
    "children": [{
      "resource": "Folder",
      "name": "Models",
      "children": [{
        "package": "ads",
        "namespace": "\\model\\ads\\Comscore",
        "model": "\\model\\ads\\Comscore",
        "item": "Comscore",
        "resourcePath": "",
        "internalPath": "\/Comscore.php",
        "modelPath": "\/model\/ads\/objects\/Comscore",
        "path": "\/model\/ads\/objects\/Comscore\/Comscore.php",
        "class": "\\model\\ads\\Comscore",
        "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/\/Comscore.php",
        "resource": "Model",
        "label": "Model",
        "extension": "php",
        "resourceType": "class",
        "subPath": "\/",
        "name": "Comscore",
        "children": [{
          "resource": "Folder",
          "name": "Datasources",
          "children": [{
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "DemographicProfile",
            "resourcePath": "",
            "internalPath": "\/datasources\/DemographicProfile.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/DemographicProfile.php",
            "class": "\\model\\ads\\Comscore\\datasources\\DemographicProfile",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/DemographicProfile.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "DemographicProfile"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "DemographicReport",
            "resourcePath": "",
            "internalPath": "\/datasources\/DemographicReport.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/DemographicReport.php",
            "class": "\\model\\ads\\Comscore\\datasources\\DemographicReport",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/DemographicReport.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "DemographicReport"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "FrequencyReport",
            "resourcePath": "",
            "internalPath": "\/datasources\/FrequencyReport.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/FrequencyReport.php",
            "class": "\\model\\ads\\Comscore\\datasources\\FrequencyReport",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/FrequencyReport.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "FrequencyReport"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "KeyMeasures",
            "resourcePath": "",
            "internalPath": "\/datasources\/KeyMeasures.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/KeyMeasures.php",
            "class": "\\model\\ads\\Comscore\\datasources\\KeyMeasures",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/KeyMeasures.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "KeyMeasures"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "SearchMedia",
            "resourcePath": "",
            "internalPath": "\/datasources\/SearchMedia.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/SearchMedia.php",
            "class": "\\model\\ads\\Comscore\\datasources\\SearchMedia",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/SearchMedia.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "SearchMedia"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "TestService",
            "resourcePath": "",
            "internalPath": "\/datasources\/TestService.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/datasources\/TestService.php",
            "class": "\\model\\ads\\Comscore\\datasources\\TestService",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/datasources\/TestService.php",
            "resource": "Datasource",
            "label": "Datasources",
            "extension": "php",
            "resourceType": "class",
            "enrutable": true,
            "router": "datasource",
            "subPath": "\/datasources",
            "name": "TestService"
          }]
        }, {
          "resource": "Folder",
          "name": "Types",
          "children": [{
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "BaseType",
            "resourcePath": "",
            "internalPath": "\/types\/BaseType.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/types\/BaseType.php",
            "class": "\\model\\ads\\Comscore\\types\\BaseType",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/types\/BaseType.php",
            "resource": "Type",
            "label": "Types",
            "extension": "php",
            "resourceType": "class",
            "subPath": "\/types",
            "name": "BaseType"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "Boolean",
            "resourcePath": "",
            "internalPath": "\/types\/Boolean.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/types\/Boolean.php",
            "class": "\\model\\ads\\Comscore\\types\\Boolean",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/types\/Boolean.php",
            "resource": "Type",
            "label": "Types",
            "extension": "php",
            "resourceType": "class",
            "subPath": "\/types",
            "name": "Boolean"
          }, {
            "package": "ads",
            "namespace": "\\model\\ads\\Comscore",
            "model": "\\model\\ads\\Comscore",
            "item": "Month",
            "resourcePath": "",
            "internalPath": "\/types\/Month.php",
            "modelPath": "\/model\/ads\/objects\/Comscore",
            "path": "\/model\/ads\/objects\/Comscore\/types\/Month.php",
            "class": "\\model\\ads\\Comscore\\types\\Month",
            "file": "\/mnt\/c\/dev\/adtopy\/\/model\/ads\/objects\/Comscore\/types\/Month.php",
            "resource": "Type",
            "label": "Types",
            "extension": "php",
            "resourceType": "class",
            "subPath": "\/types",
            "name": "Month"
          }]
        }]
      },]
    }]
  }]
  Siviglia.Utils.buildClass({
    context: 'Siviglia.RenderEngineInterface.jQWidgets.Lists',
    classes: {
      Tree: {
        inherits: 'Siviglia.Dom.EventManager',
        construct: function (params) {
          this.nodeDefinitions = params.nodeDefinitions
          this.node = params.node
          this.data = params.data
          this.dataIndexField = params.dataIndexField
          this.itemsWithAction = params.itemsWithAction
          this.jqxConfig = this.createJqxConfig()
        },
        methods: {
          render: function () {

            this.node.jqxTree({source: this.jqxConfig})
          },
          createJqxConfig: function () {
            return this.createBranchConfig(this.data)
          },
          createBranchConfig: function (data) {
            var branchConfig = []

            // no puede emplearse for (var element of data)
            // devuelve excepción porque data es Symbol
            for (var elementIndex = 0; elementIndex < data.length; elementIndex++)
              branchConfig.push(this.createItemConfig(this.nodeDefinitions[data[elementIndex][this.dataIndexField]], data[elementIndex]))

            return branchConfig
          },
          createItemConfig: function (config, data) {
            var itemConfig = {}

            // no puede emplearse if (Siviglia.isString(data))
            // devuelve excepción porque data es Symbol
            if (typeof (data) === 'string')
              itemConfig.label = data
            else if (config.field)
              itemConfig.label = data[config.field]
            else {
              var {children, ...itemData} = data
              var prefix = ''
              var suffix = ''
              var content = this.createItemSection(config.content, itemData)
              if (config.prefix)
                prefix = this.createItemSection(config.prefix, itemData)
              if (config.suffix)
                suffix = this.createItemSection(config.suffix, itemData)

              itemConfig.label = prefix + content + suffix
              itemConfig.id = Siviglia.issetOr(config.id, null)
              itemConfig.value = Siviglia.issetOr(config.value, null)
            }
            if (data.children)
              itemConfig.items = this.createBranchConfig(data.children)

            return itemConfig
          },
          createItemSection: function (config, data) {
            var elementSection = ''
            for (var elementConfig of config) {
              var id = Siviglia.createID()
              if (elementConfig.action) {
                this.itemsWithAction.push({
                  id: id,
                  type: data[this.dataIndexField],
                  action: elementConfig.action,
                  data: data
                })
              }
              elementSection += this.createItemElement(elementConfig, data, id) + ' '
            }
            return elementSection
          },
          createItemElement: function (config, data, id) {
            var content = config.field ? data[config.field] : config.content

            var element
            switch (config.type) {
              case 'text':
                element = `<span id=\'${id}\' ${config.color ? 'style=\'color:' + config.color + '\'' : ''}>${content}</span>`
                break
              case 'image':
                if (!config.height) config.height = '16px'
                if (!config.width) config.width = '16px'
                element = `<img id=\'${id}\' src=\'${content}\' style=\'height:${config.height};width:${config.width}\'>`
                break
              case 'button':
                element = `<button id=\'${id}\'>${content}</button>`
                break
              case 'icon':
                element = `<span id=\'${id}\' class=\'${content}\'></span>`
            }
            return element
          },
        }
      },
    }
  })
  Siviglia.Utils.buildClass({
    context: 'Siviglia.Widgets.Lists',
    classes: {
      TreeNode: {
        construct: function (params) {
          if (params === undefined)
            params = {}
          if (Siviglia.isString(params)) {
            this.content = {field: params}
            this.isSimpleNode = true
          }
          if (params.content) {
            this.content = params.content
            this.prefix = Siviglia.issetOr(params.prefix, null)
            this.suffix = Siviglia.issetOr(params.suffix, null)
            this.actions = Siviglia.issetOr(params.actions, null)
          }
        },
        methods: {

          createConfig: function () {
            var config = this.isSimpleNode ? this.createContent() : {content: this.createContent()}

            this.prefix = this.createPrefix()
            this.suffix = this.createSuffix()
            this.actions = this.createActions()

            for (var section of ['prefix', 'suffix', 'actions']) {
              if (section)
                config[section] = this[section]
            }

            return config
          },
          createContent: function () {
            return this.content
          },
          createPrefix: function () {
            return this.prefix
          },
          createSuffix: function () {
            return this.suffix
          },
          createActions: function () {
            return this.actions
          },
        }
      },
      FolderNode: {
        inherits: 'Siviglia.Widgets.Lists.TreeNode',
        methods: {
          createContent: function () {
            return [
              {type: 'text', field: 'name', color: 'green'},
            ]
          },
          createPrefix: function () {
            return [
              {type: 'image', content: 'http://statics.adtopy.com/packages/Siviglia/ui/tests/stubs/images/folder.jpg'},
            ]
          },
          createSuffix: function () {
            return [
              {type: 'icon', content: 'add-button', action: 'add'},
            ]
          },
          createActions: function () {
            return {
              add: {event: 'ADD_ELEMENT', callback: this.add},
            }
          },
          add: function (data) {
            console.log('add desde nodo:', data)
          }
        }
      },
      ModelNode: {
        inherits: 'Siviglia.Widgets.Lists.TreeNode',
        methods: {
          createContent: function () {
            return [
              {type: 'text', field: 'item', color: 'blue'}
            ]
          },
          createPrefix: function () {
            return [
              {type: 'image', content: 'http://statics.adtopy.com/packages/Siviglia/ui/tests/stubs/images/folder.jpg'},
            ]
          },
          createSuffix: function () {
            return [
              {type: 'icon', content: 'Dictionary-removeButton', action: 'remove'},
              {type: 'icon', content: 'edit-button', action: 'edit'},
            ]
          },
          createActions: function () {
            return {
              edit: {
                event: 'EDIT_MODEL', callback: this.edit
              },
              remove: {
                event: 'REMOVE_MODEL', callback: this.remove
              },
            }
          },
          edit: function (data) {
            console.log('edit desde nodo:', data)
          },
          remove: function (data) {
            console.log('remove desde nodo:', data)
          },
        }
      },
      Tree: {
        inherits: 'Siviglia.UI.Expando.View,Siviglia.Dom.EventManager',
        methods: {
          preInitialize: function (params) {
            this.renderEngine = params.renderEngine
            this.nodeDefinitions = params.nodeDefinitions
            this.dataIndexField = params.dataIndexField
            this.data //= null
            this.itemsWithAction = []

            this.dataSource = new Siviglia.Model.DataSource(
              params.dataSource.model,
              params.dataSource.name,
              Siviglia.issetOr(params.dataSource.params, {})
            )
            this.dataSource.freeze()
            this.dataSource.addListener('CHANGE', this, 'refreshTree')
            return this.dataSource.unfreeze().then(function () {
              this.data = this.dataSource.getRawData()
            }.bind(this))
          },
          initialize: function () {
            this.render()
          },
          render: function () {
            this.implementation = new Siviglia.RenderEngineInterface[this.renderEngine].Lists.Tree({
              node: this.containerNode,
              nodeDefinitions: this.nodeDefinitions,
              data: this.data,
              dataIndexField: this.dataIndexField,
              itemsWithAction: this.itemsWithAction,
            })
            let rendering = new Promise(function (resolve, reject) {
              this.implementation.render()
              resolve()
            }.bind(this))
            rendering.then(function () {
              this.addActionsToElements()
              this.publishTreeEvents()
            }.bind(this))
          },
          publishTreeEvents: function () {
            this.containerNode.on("added", function (event) {
              this.fireEvent('NODE_ADDED', {event: event})
            }.bind(this));
            this.containerNode.on("checkChange", function (event) {
              this.fireEvent('CHECK_CHANGED', {event: event})
            }.bind(this));
            this.containerNode.on("collapse", function (event) {
              this.fireEvent('BRANCH_COLLAPSED', {event: event})
            }.bind(this));
            this.containerNode.on("dragStart", function (event) {
              this.fireEvent('DRAG_START', {event: event})
            }.bind(this));
            this.containerNode.on("dragEnd", function (event) {
              this.fireEvent('DRAG_END', {event: event})
            }.bind(this));
            this.containerNode.on("expand", function (event) {
              this.fireEvent('BRANCH_EXPANDED', {event: event})
            }.bind(this));
            this.containerNode.on("initialized", function (event) {
              this.fireEvent('INITIALIZED', {event: event})
            }.bind(this));
            this.containerNode.on("itemClick", function (event) {
              this.fireEvent('ITEM_CLICKED', {event: event})
            }.bind(this));
            this.containerNode.on("removed", function (event) {
              this.fireEvent('NODE_REMOVED', {event: event})
            }.bind(this));
            this.containerNode.on("select", function (event) {
              this.fireEvent('NODE_SELECTED', {event: event})
            }.bind(this));
          },
          addActionsToElements: function () {
            this.itemsWithAction.forEach(function (item) {
              var actionConfig = this.nodeDefinitions[item.type].actions[item.action]
              this.addListener(actionConfig.event, this, 'executeEventCallback')
              $('#' + item.id).click(function () {
                this.fireEvent(actionConfig.event, {callback: actionConfig.callback, data: item.data})
              }.bind(this))
            }.bind(this))
          },
          executeEventCallback: function (event, data) {
            data.callback(data.data)
          },
        }
      },
      ReflectionTree: {
        inherits: 'Siviglia.Widgets.Lists.Tree',
        methods: {
          preInitialize: function () {
            this.PackageNode = new Siviglia.Widgets.Lists.TreeNode('name')
            this.FolderNode = new Siviglia.Widgets.Lists.FolderNode()
            this.ModelNode = new Siviglia.Widgets.Lists.ModelNode()
            this.definition = {
              renderEngine: 'jQWidgets',
              dataSource: {
                model: '/model/reflection/ReflectorFactory',
                name: 'fullTree',
                // params: {},
              },
              dataIndexField: 'resource',
              /*
              * Para configurar una hoja se puede hacer de 2 formas:
              * - pasar un objeto:
              *     {field: 'nombre del campo'}
              *     indica qué campo de los datos toma se emplea para generar el contenido
              * - pasar un objeto:
              *     {
              *      content: [
              *                 {
              *                type: [text, image, button],
              *                field/content: [campo del que tomar valor / valor del campo],
              *                resto de parámetros del tipo:
              *                     text -> color
              *                     image -> height, width
              *                     button -> ninguno
              *                 },
              *                 ...
              *               ]
              *      prefix: igual que content
              *      suffix: igual que content
              *     }
              * */
              nodeDefinitions: {
                Package: this.PackageNode.createConfig(),//{field: 'name'},
                Folder: this.FolderNode.createConfig(),
                Model: this.ModelNode.createConfig(),
                Datasource: {field: 'item'},
                Type: {field: 'item'},
                ModelConfig: {field: 'name'},
                Action: {field: 'name'},
                HtmlView: {field: 'item'},
                HtmlForm: {field: 'item'},
                JsForm: {field: 'item'},
                Cache: {field: 'item'},
                JsApp: {field: 'item'},
                JsModel: {field: 'item'},
                JsView: {field: 'item'},
                Worker: {field: 'name'},
                Detector: {field: 'name'}
              }
            }
            /*
            * Como el dataSource fullTree tiene una respuesta diferente a la habitual, no se puede emplear y hay que
            * ajustar la respuesta
            * this.Tree$preInitialize(this.definition)
            * Se toma el código de Tree$preInitialize
            * */
            this.renderEngine = this.definition.renderEngine
            this.nodeDefinitions = this.definition.nodeDefinitions
            this.dataIndexField = this.definition.dataIndexField
            this.data
            this.itemsWithAction = []

            this.dataSource = new Siviglia.Model.DataSource(
              this.definition.dataSource.model,
              this.definition.dataSource.name,
              Siviglia.issetOr(this.definition.dataSource.params, {})
            )
            this.dataSource.freeze()
            this.dataSource.addListener('CHANGE', this, 'refreshTree')
            /*return this.dataSource.unfreeze().then(function () {
              /!*
              * La siguiente línea tendría que ser: this.data = this.dataSource.getRawData()
              * Esta es la razón por la que se repite este código de Tree$preInitialize.
              * *!/
              this.data = this.dataSource.getRawData()[0].root.children
            }.bind(this))*/
            this.data = theData
          },
          initialize: function () {
            this.Tree$initialize()
          },
        }
      },
    }
  })
</script>