<style>
    .remove, .NewItemString .add {
        font-family:'IcoMoon'
    }
    .remove:before {

    }
    .description:empty {display:none}
    .NewItemString .add {
        margin-left: 5px;
        margin-top: 6px;
        color: green;
    }
    .add:before {
        font-family:"Ionicons";
        content: '\f359';
        font-size: 20px;
    }
    .remove {
        font-family: 'IcoMoon';
    }
    input[type=checkbox]{
        width:15px !important;
        height:15px !important;
    }
    .ContainerType {}

    .ContainerType .ContainerType .containerLabel {
        min-width:150px !important;
        font-size:12px
    }
    .containerInput {
        display: table-cell;
    }
    .dictionaryInput {
        min-width:200px;
        max-height:250px;
        overflow-y:scroll;
    }
    .removebutton:after {
        font-family:"Ionicons";
        font-size: 16px;
        content: "\f128";
        color: darkred;
        margin-top: 7px;
        margin-left: 5px;
    }
    .navbar-form {
        padding:0px !important;
    }
</style>
<script>

    Siviglia.Utils.buildClass(
        {
            context: 'Siviglia.inputs.jqwidgets',
            classes: {
                Factory:{
                    methods:{
                        getInput:function(type,params,form)
                        {
                            var stype=type.__definition["TYPE"];
                            var d=$.Deferred();
                            if(!Siviglia.isset(params))
                                params={};
                            //if(Siviglia.isset(params.controller))
                            //    type.setController(params.controller);
                            var dv=$('<div></div>');
                            var p=params || {};
                            if(typeof form!=="undefined") {
                                var formParams = form.getFormParams(type.__getFieldPath());
                                if (formParams) {
                                    for (var k in formParams)
                                        p[k] = formParams[k];
                                }
                            }
                            p.type=type;
                            p.form=form;




                            var input=Siviglia.issetOr(p["INPUT"],null);
                            if(!input) {
                                switch (stype) {
                                    case "Integer":
                                    case "String": {
                                        if (type.__hasSource())
                                            input = "ComboBox";
                                        else
                                            input=stype;
                                    }
                                        break;
                                    default:
                                    {
                                        input=stype
                                    }
                                }
                            }
                            if(type.relaxed)
                            {
                                switch(stype)
                                {
                                    case "Boolean":
                                    {
                                        input="BooleanCombo";
                                    }break;
                                }
                            }
                            var stack = new Siviglia.Path.ContextStack();
                            var instance=new Siviglia.inputs.jqwidgets[input](
                                //"Siviglia.inputs.jqwidgets."+input,
                                input.indexOf(".")>-1?input:"Siviglia.inputs.jqwidgets."+input,
                                p,
                                {},
                                dv,
                                stack
                            );
                            instance.__build().then(function(){
                                // Se crea el layout y se le pasa la instancia.

                                d.resolve(instance);

                            })
                            return d;

                        }
                    }
                },


                BaseInput: {
                    inherits: "Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",
                    destruct:function()
                    {
                      this.clearErrors();
                      // Destruccion del jqxInput
                      var widgetName=this.getJqxWidgetName();

                      if(this.inputNode) {
                          this.inputNode[widgetName]('destroy');
                          var ariaNode=this.inputNode.attr("aria-owns");
                          if(ariaNode)
                          {
                              var R=new RegExp(ariaNode,"i");
                              var curEvents=$._data(document,"events");
                              for(var k in curEvents)
                              {
                                  var curList=curEvents[k];
                                  for(var j = 0;j<curList.length;j++)
                                  {
                                      if(R.exec(curList[j].namespace))
                                      {
                                          jQuery(document).off(curList[j]["type"], curList[j]["namespace*"]);
                                      }
                                  }
                              }
                          }
                      }
                      if(this.stateDriven)
                      {
                          var controller=this.type.__getController();
                          var stDef=controller.getStateDef();
                          var stateType=stDef.getStateFieldObj();
                          stateType.removeListeners(this);
                      }
                      this.type.removeListeners(this);
                      for(var k in this.subWidgets)
                      {
                          this.subWidgets[k].destruct();
                      }
                    },
                    methods: {
                        preInitialize: function (params) {
                            this.subWidgets={};
                            this.errored = false;
                            this.controller = this.parentView;
                            this.stateDriven=false;
                            this.tooltipNode=null;
                            this.changing=false;
                            this.hasGlobalErrors=false;
                            this.description="";
                            this.errorMessage = "";
                            this.form=Siviglia.issetOr(params.form,null);
                            //El inputWrapper es la estructura que contiene este
                            // input, y que consiste en el input, la label, la ayuda,etc
                            this.inputWrapper=Siviglia.issetOr(params.inputWrapper,null);
                            this.type = params.type;

                            this.type.addListener("CHANGE",this,"onTypeChanged");
                            this.type.addListener("ERROR",null,function(){console.dir("ON_ERROR")});
                            this.helpMessage = Siviglia.issetOr(this.type.__definition.HELP, null);
                            this.hasHelpMessage = (this.helpMessage != null ? true : false);
                            this.inputParams = Siviglia.issetOr(params.inputParams, {});
                            this.formParams=Siviglia.issetOr(params.formParams,{});


                        },
                        initialize: function (params) {
                            var opts = this.getDefaultInputOptions();
                            for (var k in this.inputParams)
                                opts[k] = this.inputParams[k];
                            if(!this.type.__isEditable())
                                opts.disabled=true;
                            var controller=this.type.__getController();

                            if(controller!==null && controller.getStateDef()!==null)
                            {
                                var stDef=controller.getStateDef();
                                var stateType=stDef.getStateFieldObj();
                                if(stateType!==this.type)
                                {
                                    this.stateDriven=true;
                                    this.__checkEditable=function(ev){
                                        this.callInp({disabled:!this.type.__isEditable()});
                                    }
                                    stateType.addListener("CHANGE",this,"__checkEditable");
                                    this.stateDriven=true;
                                }
                            }
                            this.createInput(opts);
                            this.inputNode[this.getJqxWidgetName()]('theme', 'light');
                            var m = this;
                            this.tooltipNode=this.inputNode;
                            var changeFunc=this.debounce(
                                function () {
                                    if (m.changing)
                                        return;
                                    m.changing=true;
                                    try {

                                        m.type.setValue(m.getValue());
                                        if(m.type.__isErrored()) {
                                            var error=m.type.__getError()
                                            m.showError(
                                                Siviglia.i18n.es.base.getErrorFromJsException(error)
                                            );
                                        }
                                        else
                                            m.clearErrors();
                                    }catch(e)
                                    {
                                        m.showError(
                                            Siviglia.i18n.es.base.getErrorFromJsException(e)
                                        );
                                    }
                                    m.changing=false;
                                }
                            ,250);
                            // Aqui se escuchan los cambios de input.
                            this.inputNode.on("change", changeFunc);
                            // Pero si el tipo es un parametro dinamico, necesitamos que se dispare la funcion en "keyup"
                            if(this.type.__isDynamic())
                                this.inputNode.on("keyup",changeFunc);

                            if (this.type.is_set()) {
                                var toSet = this.type.getValue();
                                this._setInputValue(toSet);

                                if(this.type.__isErrored()) {
                                    var m=this;
                                    setTimeout(function(){
                                    var error=m.type.__getError();

                                    m.showError(
                                        Siviglia.i18n.es.base.getErrorFromJsException(error)
                                    );
                                    },500);
                                }
                            }
                        },
                        addSubWidget:function(field,widget)
                        {

                            this.subWidgets[field]=widget;
                        },
                        showPath:function(path)
                        {
                            // Aqui no deberia llegar nunca.En los tipos basicos, showPath
                            // tendría que ser utilizado en el inputWrapper, que no lo pasaría al input final.
                        },
                        removeSubWidget:function(field)
                        {
                            delete this.subWidgets[field];
                        },
                        debounce:function(func, wait, immediate) {
                            var timeout;
                            return function() {
                                var context = this, args = arguments;
                                var later = function() {
                                    timeout = null;
                                    if (!immediate) func.apply(context, args);
                                };
                                var callNow = immediate && !timeout;
                                clearTimeout(timeout);
                                timeout = setTimeout(later, wait);
                                if (callNow) func.apply(context, args);
                            };
                        },
                        onTypeChanged:function(event,params)
                        {
                            if(this.changing===false)
                            this._setInputValue(params.data.getValue());
                        },
                        detach:function()
                        {
                            this.Widget$detach();
                            this.type.removeListeners(this);
                        },
                        getDefaultInputOptions: function () {
                            return {};
                        },
                        createInput: function (options) {

                            return this.callInp(options)
                        },
                        _setInputValue: function (toSet) {
                            this.changing = true;
                            //this.inputNode[this.getJqxWidgetName()]('val', toSet);
                            $(this.inputNode).val(toSet);
                            this.changing = false;
                        },
                        getValue: function () {
                            //return this.inputNode[this.getJqxWidgetName()]('val');
                            return $(this.inputNode).val();
                        },

                        save:function()
                        {
                            try{

                                if(typeof this.inputNode!=="undefined" && !this.type.equals(this.getValue()))
                                    this.type.setValue(this.getValue());
                                this.clearErrors();
                            }catch(e)
                            {
                                this.showError(
                                    Siviglia.i18n.es.base.getErrorFromJsException(e)
                                );
                            }
                        },

                        focus:function()
                        {
                            this.rootNode[0].scrollIntoView();
                            if(this.inputNode)
                                this.inputNode.focus();
                        },
                        showError: function (message,dontAppend) {
                            // Se guarda referencia del puntero al nodo del error <span...>
                            this.errorNode = this.inputWrapper.errorNode;
                            
                            // Nos guardamos si hay excepcion en el tipo
                            var exception_input_path = this.type.__errorException;

                            // Comprobamos la excepción del tipo. Si es distinto de null, es cuando SI se pinta/muestra el error
                            if (exception_input_path !== null){
                                if (typeof this.errorNode !== "undefined"){
                                    this.errorNode.style.display = "";          // hacemos que se vea el <span> eliminando el display: none
                                    this.errorNode.innerText = message;         // insertamos el mensaje de error en el span del input.
                                    this.inputWrapper.inputNode[0].children[1].classList.add("show-errored");   // ponemos clase de error en el input 
                                }
                            }                          
                                                       
                            // Añadimos path de error de dicho input
                            this.form.appendError(this.type.getFullPath(),this);
                        },
                        clearErrors: function () {
                            // Nos guardamos si hay excepcion en el tipo
                            var exception_input_path = this.type.__errorException;
                            
                            // Comprobamos que no esté vacío el inputWrapper
                            if (this.inputWrapper !== null) {
                                
                                // Se guarda referencia del puntero al nodo del error <span...>
                                this.errorNode = this.inputWrapper.errorNode;

                                // Comprobamos la excepción del tipo. Si es distinto de null, es cuando NO se elimina el error
                                if (exception_input_path === null) {

                                    // Comprobación para evitar dar un error en la consola
                                    if (typeof this.inputWrapper.rootNode[0].children[3] !== "undefined") {
                                        // quitamos los estilos de errores del nodo de error y más abajo del input
                                        this.errorNode.style.display = "none";
                                        this.errorNode.innerText = "";
                                    }

                                    // Se quita la clase que resalta el error del input
                                    if (typeof this.inputNode !== "undefined") {
                                        this.inputNode.removeClass("show-errored");
                                        //console.dir("CLEAR_ERROR");
                                    }

                                }// if__exception_input_path
                            }
                            
                            // Si no está vacío el formulario, se llama a la función que se encarga de eliminar el path del error
                            if(this.form!==null)
                                this.form.clearError(this.type.getFullPath(),this);                            
                        },
                        getJqxWidgetName: function () {
                            return "jqxInput";
                        },
                        callInp: function (obj) {
                            return this.inputNode[this.getJqxWidgetName()](obj);
                        },
                        disable: function () {
                            this.callInp({disabled: true});
                        },
                        enable: function () {
                            this.callInp({disabled: false});
                        },
                        on:function(event,callback)
                        {
                            this.inputNode.on(event,callback);
                        }
                    }
                },
                String: {
                    /*
                     disabled	Boolean	false
                     dropDownWidth	Number/String	null
                     displayMember	String	""
                     height	Number/String	null
                     items	Number	8
                     minLength	Number	1
                     maxLength	Number	null
                     opened	Boolean	false
                     placeHolder	String	""
                     popupZIndex	Number	20000
                     query	String	""
                     renderer	function	null
                     rtl	Boolean	false
                     searchMode	String	'default'
                     source	Array, function	[]
                     theme	String	''
                     valueMember	String	""
                     width
                     */
                    inherits: "Siviglia.inputs.jqwidgets.BaseInput",
                    methods: {
                        getDefaultInputOptions: function () {
                            var d = this.type.__definition;

                            if (d.LABEL == null)
                                d.LABEL= 'dato';

                            // if (d.FIXED !== null)


                            var opts = {
                                placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],"Insertar "+ d.LABEL +"...")
                            };
                            if (d.MINLENGTH)
                                opts.minLength = d.MINLENGTH;
                            if (d.MAXLENGTH)
                                opts.maxLength = d.MAXLENGTH;
                            return opts;

                        },
                     /*   createInput:function(opts)
                        {
                            var d=this.type.__definition;
                            if(typeof d.PARAMTYPE!=="undefined" && d.PARAMTYPE==='DYNAMIC')
                            {
                                // Poner callback de keyup, con debouncer
                            }

                        }*/

                    }
                },
                Enum: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            var finalOpts = [];
                            var d = this.type.__definition;
                            for (var k = 0; k < d.VALUES.length; k++) {
                                var c = d.VALUES[k];
                                var label, value;
                                label = value = c;
                                if (typeof c == "object") {
                                    label = c.LABEL;
                                    value = c.VALUE;
                                }
                                finalOpts.push(
                                    {
                                     //   html: '<div tabIndex=0 style="padding:1px">' + label + '</div>',
                                        label: label,
                                        value: value
                                    }
                                )
                            }
                            var opts = {
                                source: finalOpts, //finalOpts,
                                placeHolder: 'Seleccionar',
                                autoComplete: false,
                                height: 25,
                                displayMember: "label",
                                valueMember: "value",
                                width: '100%',
                                minLength: 0
                            };
                            return opts;
                        },
                        getJqxWidgetName: function () {
                            return "jqxComboBox";
                        },
                        _setInputValue:function(v)
                        {
                            this.changing = true;
                            var curLabel=this.type.getLabel();
                            this.inputNode[this.getJqxWidgetName()]('val', curLabel);
                            this.changing = false;
                        }
                    }
                },
                Integer: {
                    inherits: 'BaseInput',
                    methods: {
                        /* {value: null,
                         decimal: 0,
                         min: -99999999,
                         max: 99999999,
                         width: 200,
                         validationMessage: "Invalid value",
                         height: 25, textAlign: "right", readOnly: false,
                         promptChar: "*",
                         decimalDigits: 2,
                         decimalSeparator: ".", groupSeparator: ",", groupSize: 3, symbol: "", symbolPosition: "left", digits: 8, negative: false, negativeSymbol: "-", disabled: false, inputMode: "advanced", spinButtons: false, spinButtonsWidth: 18, spinButtonsStep: 1, autoValidate: true, spinMode: "advanced", enableMouseWheel: true, touchMode: "auto", rtl: false, events: ["valueChanged", "textchanged", "mousedown", "mouseup", "keydown", "keyup", "keypress", "change"], aria: {"aria-valuenow": {name: "decimal", type: "number"}, "aria-valuemin": {name: "min", type: "number"}, "aria-valuemax": {name: "max", type: "number"}, "aria-disabled": {name: "disabled", type: "boolean"}}, invalidArgumentExceptions: ["invalid argument exception"]};
                         */
                        getDefaultInputOptions: function () {

                            return {decimalDigits: 0};
                        },
                        getJqxWidgetName: function () {
                            return "jqxNumberInput";
                        }
                    }
                },
                Decimal: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            var d = this.type.__definition;
                            return {decimalDigits: d.NDECIMALS, digits: d.NINTEGERS};
                        },
                        getJqxWidgetName: function () {
                            return "jqxNumberInput";
                        }
                    }
                },
                Text: {
                    inherits: 'BaseInput',
                    methods: {
                        initialize: function (params) {
                            var m = this;
                            $(document).ready(function () {
                                m.BaseInput$initialize(params);
                            });
                        },
                        getDefaultInputOptions: function () {
                            return {
                                //height: "400px",
                                //width: '200px'
                            };
                        },
                        getJqxWidgetName: function () {
                            return "jqxInput";
                        }

                    }
                },
                AutoIncrement: {
                    inherits: 'Siviglia.UI.Expando.View,Siviglia.Dom.EventManager',
                    methods: {
                        preInitialize: function (params) {
                            this.value = params.type.getValue();
                        },
                        initialize: function (params) {

                        },
                        getValue: function () {
                            return this.type.getValue();
                        }
                    }
                },
                Boolean: {
                    inherits: 'BaseInput',
                    methods: {
                        getDefaultInputOptions: function () {
                            return {width: 20, height: 20};
                        },
                        getJqxWidgetName: function () {
                            return "jqxCheckBox";
                        },
                        _setInputValue: function (value) {
                            if (value == null || value == "0" || value == "false" || value == false)
                                this.inputNode.jqxCheckBox({checked: false});
                            else
                                this.inputNode.jqxCheckBox({checked: true});
                        },
                        getValue: function () {
                            return this.inputNode.val() ? "1" : "0";
                        }
                    }
                },

                ComboBox: {
                    inherits: 'BaseInput',
                    destruct:function()
                    {
                        var s = this.type.__getSource();
                        s.removeListeners(this);

                    },
                    methods: {
                        preInitialize: function (params) {
                            this.preprocessParams(params);
                            this.source=null;
                            this.dataBinding=false;
                            this.BaseInput$preInitialize(params);
                        },
                        initialize: function (params) {

                            var opts = this.getDefaultInputOptions();
                          //  for (var k in this.inputParams)
                          //      opts[k] = this.inputParams[k];
                            this.createInput(opts);
                            this.inputNode[this.getJqxWidgetName()]('theme', 'light');
                            this.type.addListener("ERROR",null,function(){console.log("ON ERROR")});
                            var m = this;
                            this.inputNode.on("select", function (ev) {
                                if(!m.dataBinding && !m.changing) {
                                    if (ev.args) {
                                        m.changing = true;
                                        var newVal = ev.args.item.value;
                                        try {
                                            if (newVal == -1) {
                                                m.type.setValue(null);
                                            } else {
                                                m.type.setValue(m.getValue());
                                            }
                                            m.clearErrors();
                                        } catch (e) {
                                            this.showError(
                                                Siviglia.i18n.es.base.getErrorFromJsException(e)
                                            );
                                        }
                                        m.changing = false;
                                    }
                                }
                                else
                                {
                                    m._setInputValue(null);
                                }
                            })


                            if (this.disabled) {

                                this.disable();
                                return;
                            }
                            else
                                this.refresh();

                        },
                        detach:function()
                        {
                            this.BaseInput$detach();
                            if(this.source)
                                this.source.removeListeners(this);
                        },
                        preprocessParams: function (params) {
                            this.type=params.type;
                            var s=this.type.__getSource();
                            this.labelField = s.getLabelExpression()?"LABEL_EXPRESSION":s.getLabelField();
                            this.valueField = s.getValueField();
                        },
                        getValue: function () {
                            var v = this.inputNode.jqxComboBox('val');
                            if (v == '')
                                v = null;
                            return v;
                        },
                        getJqxWidgetName: function () {
                            return "jqxComboBox";
                        },
                        getDefaultInputOptions: function () {
                            var self = this;
                            this.dataSource = {
                                localdata: [],
                                datatype: "array"
                            };
                            this.dataAdapter = new $.jqx.dataAdapter(self.dataSource);
                            return {
                                source: this.dataAdapter,
                                openDelay: 200,
                                autoComplete: true,
                                autoBind: false,
                                minLength: 1,
                                remoteAutoComplete: true,
                                displayMember: this.getLabelField(),
                                valueMember: this.getValueField(),
                                autoDropDownHeight: true,
                                width: '100%',
                                height: 25,
                                placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],"--Select"),
                                search: function (str) {
                                    console.log("SEARCHING");
                                    self.source.search(str);
                                   // self.searchString = str;
                                   // self.refresh();
                                }
                            };
                        },
                        _setInputValue: function (toSet) {
                            if (this.changing)
                                return;
                            this.changing = true;
                            if(toSet==null)
                            {

                                this.inputNode.jqxComboBox('selectItem',-1);
                                this.inputNode.jqxComboBox('val','');
                                this.type.setValue(null);

                            }
                            else {
                                var item = this.inputNode.jqxComboBox('getItemByValue', toSet);
                                if (item) {
                                    this.inputNode.jqxComboBox('selectItem', item);
                                    this.inputNode.jqxComboBox('val', item.label);
                                }
                            }
                            this.changing = false;
                        },
                        getLabelField: function () {
                            return this.labelField;
                        },
                        getValueField: function () {
                            return this.valueField;
                        },
                        buildParameters: function () {
                            var obj = {
                                "search": this.searchString
                            };
                            if (this.sourceParameters) {
                                for (var k in this.sourceParameters) {
                                    obj[k] = this.sourceParameters[k];
                                }
                            }
                            return obj;
                        },
                        refresh: function () {
                            if (this.disabled)
                                return;
                            var params = this.buildParameters();
                            this.getSource(params);

                        },
                        getSource: function (params) {
                            if(this.source==null) {
                                //this.type.clear();
                                var plainCtx = new Siviglia.Path.BaseObjectContext(this.controller, "*");
                                var s = this.type.__getSource();
                                s.addContext(plainCtx);
                                s.addListener("CHANGE", this, "onSourceChanged");

                                this.source=s;
                            }
                            this.source.fetch();
                            return this.source;

                        },
                        onSourceChanged:function(evName,data)
                        {
                            var self=this;
                            // Vemos ahora en data

                            this.dataSource.localdata = [];
                            if(data.value!==null)
                            {
                                this.dataSource.localdata=data.value;
                                if(this.source.getLabelExpression()!==null) {
                                    for (var k = 0; k < data.value.length; k++)
                                        data.value[k]["LABEL_EXPRESSION"]=this.source.getLabel(data.value[k])

                                }
                            }

                            // La llamada a dataBind genera un problema en select anidados:
                            // Si existen dos select anidados, S1 y S2, ocurre lo siguiente:
                            // Inicialmente, S1 y S2 están en blanco. Se selecciona un item de S1. S2 sigue en blanco.
                            // Se selecciona ahora un valor de S2.
                            // Posteriormente, se cambia el valor de S1. El valor de S2 ahora deberia ponerse en blanco,
                            // ya que su valor dependia del valor antiguo de S1.
                            // En vez de eso, lo que ocurre es que al llamar a dataBind, se genera un evento "select", y se
                            // autoselecciona el primer valor del nuevo set de datos asignado a S2.
                            // Por eso, se marca que estamos haciendo el databind, para controlarlo en el gestor de eventos.
                            this.dataBinding=true;
                            self.dataAdapter.dataBind();
                            this.dataBinding=false;
                            if (self.type.is_set()) {
                                var toSet = self.type.getValue();
                                var it = self.inputNode.jqxComboBox('getItemByValue', toSet);
                                if (it) {
                                    self._setInputValue(toSet);
                                }
                                else {
                                    self.type.unset();
                                    this.inputNode.jqxComboBox('selectItem',-1);
                                    this.inputNode.jqxComboBox('val','');
                                }
                            }
                            else
                            {
                                //self._setInputValue(null);
                                this.inputNode.jqxComboBox('selectItem',-1);
                                this.inputNode.jqxComboBox('val','');
                            }
                        }

                    }
                },
                BooleanCombo:{
                    inherits:"ComboBox",
                    methods:{
                        preInitialize: function (params) {
                            this.source=null;
                            this.dataBinding=false;
                            this.labelField="LABEL";
                            this.valueField="VALUE";
                            this.BaseInput$preInitialize(params);
                        },
                        getSource: function (params) {
                            if(this.source==null) {
                                //this.type.clear();
                                var stack = new Siviglia.Path.ContextStack();
                                var factory=new Siviglia.Data.SourceFactory();
                                var s=factory.getFromSource({
                                    "TYPE": "Array",
                                    "DATA":
                                        [
                                            {"LABEL":"Seleccionar","VALUE":null},
                                            {"LABEL":"True","VALUE":true},
                                            {"LABEL":"False","VALUE":false}
                                        ],
                                    "LABEL":"LABEL",
                                    "VALUE":"VALUE"
                                },this.type,stack);
                                s.addListener("CHANGE", this, "onSourceChanged");
                                this.source=s;
                            }
                            this.source.fetch();
                            return this.source;
                        }
                    }
                },
                FixedSelect:
                    {
                        inherits: 'ComboBox',
                        methods:{
                            getDefaultInputOptions:function()
                            {
                                var self = this;
                                this.dataSource = {
                                    localdata: [],
                                    datatype: "array"
                                };
                                this.dataAdapter = new $.jqx.dataAdapter(self.dataSource);
                                return {
                                    source: this.dataAdapter,
                                    autoBind: true,
                                    displayMember: this.getSearchField(),
                                    valueMember: this.getValueField(),
                                    autoDropDownHeight: true,
                                    width: 200,
                                    height: 25,
                                    placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],null)
                                };
                            }
                        }
                    },
                Relationship:{
                    inherits:'ComboBox'
                },
                Date:{
                    inherits:'BaseInput',
                    methods:
                        {
                            getDefaultInputOptions: function () {
                               // añadida propiedad para que el icono del calendario sea fluid 100%
                               return {width: '100%'};
                            },
                            _setInputValue: function (toSet) {
                                this.changing = true;
                                //this.inputNode[this.getJqxWidgetName()]('val', toSet);
                                $(this.inputNode).val(new Date(toSet));
                                this.changing = false;
                            },
                            getJqxWidgetName: function () {
                                return "jqxDateTimeInput";
                            },
                            getValue:function()
                            {
                                var val = this.inputNode.jqxDateTimeInput('value');
                                if (val != null)
                                {
                                    var v=val.getMonth()+1;
                                    if(v<10)
                                        v='0'+v;
                                    var d=val.getDate();
                                    if(d<10)
                                        d='0'+d;
                                    var tt= val.getFullYear() + "-" + v + "-" + d;
                                    console.dir(tt);
                                    return tt;
                                }
                                return null;
                            }
                        }
                },
                DateTime:{
                    inherits:'Date',
                    methods:
                        {
                            _setInputValue: function (toSet) {
                                this.changing = true;
                                //this.inputNode[this.getJqxWidgetName()]('val', toSet);
                                $(this.inputNode).val(new Date(toSet));
                                this.changing = false;
                            },
                            getValue: function () {
                                var val = this.inputNode.jqxDateTimeInput('value');
                                if (val != null)
                                {
                                    var v=val.getMonth()+1;
                                    if(v<10)
                                        v='0'+v;
                                    var d=val.getDate();
                                    if(d<10)
                                        d='0'+d;
                                    var h=val.getHours();
                                    if(h<10)
                                        h='0'+h;
                                    var m=val.getMinutes();
                                    if(m<10)
                                        m='0'+m;
                                    var s=val.getSeconds();
                                    if(s<10)
                                        s='0'+s;

                                    return val.getFullYear() + "-" + v + "-" + d + " " + h + ":" + m + ":" + s;
                                }
                                return null;
                            }
                        }
                },
                Money:{
                    inherits:'Decimal'
                },
                Password:{
                    inherits:'String',
                    methods:{
                        getDefaultInputOptions: function () {
                            var opts = {
                                // width: 200,
                                minLength: 0,
                                placeHolder:Siviglia.issetOr(this.inputParams["placeholder"],"Password...")
                            };
                            return opts;
                        },
                        getJqxWidgetName: function () {
                            return "jqxPasswordInput";
                        }
                    }
                },
                State:{
                    inherits:'Enum',
                    methods: {
                        onTypeChanged:function(event,params){
                            this.Enum$onTypeChanged(event,params);
                            this.callInp(this.getDefaultInputOptions());
                            var wasChanging=this.__changing;
                            this.__changing=true;
                            this.inputNode.val(this.type.getLabel());
                            this.__changing=wasChanging;
                        },
                        getDefaultInputOptions: function () {
                            var finalOpts = [];
                            var stDef=this.type.__getController().getStateDef();
                            var id=this.type.getValue();
                            var label=stDef.getCurrentStateLabel();
                            var isFinal=stDef.isFinalState(label);

                            var d = this.type.__definition;
                            for (var k = 0; k < d.VALUES.length; k++) {
                                var c = d.VALUES[k];
                                if(c==label || stDef.canTranslateTo(k))
                                {
                                    finalOpts.push(
                                        {
                                            //   html: '<div tabIndex=0 style="padding:1px">' + label + '</div>',
                                            label: c,
                                            value: c
                                        }
                                    )

                                }
                            }
                            var opts = {
                                source: finalOpts, //finalOpts,
                                placeHolder: 'Seleccionar',
                                autoComplete: false,
                                height: 25,
                                displayMember: "label",
                                valueMember: "value",
                                width: '100%',
                                minLength: 0,
                                disabled:isFinal
                            };
                            return opts;
                        },
                        getJqxWidgetName: function () {
                            return "jqxComboBox";
                        },
                        _setInputValue:function(v)
                        {
                            this.changing = true;
                            var curLabel=this.type.getLabel();
                            this.inputNode[this.getJqxWidgetName()]('val', curLabel);
                            this.changing = false;
                        },

                        save:function()
                        {
                            try{
                                this.type.save();
                                this.clearErrors();
                                var opts=this.getDefaultInputOptions();
                                this.callInp(opts);
                            }catch(e)
                            {
                                this.showError(
                                    Siviglia.i18n.es.base.getErrorFromJsException(e)
                                );
                            }
                        }
                    }
                },
                Name:{
                    inherits:'String'
                },
                Street:{
                    inherits:'String'
                },
                City:{
                    inherits:'String'
                },
                Phone:{
                    inherits:'String'
                },
                UUID:{
                    inherits:'String'
                },
                Model:{
                    inherits:'ComboBox'
                },
                Dictionary:
                    {
                        inherits:'BaseInput',
                        destruct:function()
                        {

                            if(this.currentWidget)
                                this.currentWidget.destruct();
                            this.currentWidget=null;


                        },
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.title="";
                                    this.self=this;
                                    this.hasSimpleType=false;
                                    this.description="";
                                    this.BaseInput$preInitialize(params);
                                    this.currentKey=null;
                                    this.hasCurrentKey=false;
                                    if(this.type.getValue()===null)
                                        this.type.setValue({});

                                    this.currentWidget=null;
                                    this.currentType=null;
                                    this.params=params;
                                    this.currentErrors={};

                                },

                                initialize:function(params)
                                {
                                },
                                _setInputValue:function(toSet)
                                {

                                },
                                showPath:function(key)
                                {
                                    // Showpath solo tiene que seleccionar la key del path, en caso de que
                                    // no fuera la seleccionada.
                                    if(typeof this.subWidgets[key]==="undefined")
                                    {
                                        this.currentKey = key;
                                        if(this.hasCurrentKey===false)
                                        this.hasCurrentKey = true;
                                    }
                                },
                                buildNewItemWidget:function(node,params)
                                {
                                    if(this.newItemWidget) {
                                        this.newItemWidget.destruct();
                                    }
                                    node.html("");
                                    var pp=this.params;
                                    pp.parentInput=this;
                                    var tempNode=$("<div></div>");
                                    this.newItemWidget=new Siviglia.inputs.jqwidgets.NewItem('Siviglia.inputs.jqwidgets.NewItem',
                                        pp,
                                        {},
                                        tempNode,
                                        this.__context
                                    );
                                    this.newItemWidget.__build().then(function(){node.append(tempNode);})
                                },
                                onLabelClicked:function(node, params)
                                {
                                    if(this.currentWidget!=null) {

                                        this.currentWidget.destruct();
                                        this.currentWidget = null;
                                    }

                                    // Hacemos esto para evitar doble repintado del widget, ya que hay
                                    // listeners para ambas variables.

                                    this.currentKey=params.key;
                                    this.currentType=this.type["*"+this.currentKey];
                                    this.hasCurrentKey=true;


                                    // Custom class for active element in Dictionary
                                    var elements_with_selected = document.getElementsByClassName("seleccionado");

                                    // Eliminacion de clases con dicho valor "seleccionado"
                                    for (var i=0; i<elements_with_selected.length; i++){
                                        elements_with_selected[i].classList.remove("seleccionado");
                                    }

                                    // Teniendo el nodo, nos posicionamos en el elemento a insertar
                                    // la nueva clase "seleccionado"
                                    if (node !== null){
                                        var value_selected = node[0].parentElement.parentNode;
                                        value_selected.classList.add("seleccionado");
                                    }
                                    /*TODO, cuando el nodo está null.

                                    Es decir, cuando se ha insertado un dato nuevo,
                                    ver la forma de añadirle esa clase "seleccionado"
                                    ¿con document.getElement...?
                                    */

                                },
                                onRemoveClicked:function(node,params,event)
                                {
                                    if(params.key==this.currentKey && this.currentWidget!=null)
                                    {
                                        this.currentWidget.destruct();
                                    }
                                    this.hasCurrentKey=false;
                                    this.currentKey=null;
                                    this.currentType=null;
                                    this.currentWidget=null;
                                    var v=this.type.getValue();
                                    delete v[params.key];
                                    //this.type.removeItem(params.key);

                                },
                                onAdd:function(val)
                                {
                                    this.type.addItem(val);
                                    this.onLabelClicked(null,{key:val});
                                }
                            }
                    },
                Container:
                    {
                        inherits:'Dictionary',
                        destruct:function(){

                            for(var k in this.registeredInputs)
                                this.registeredInputs[k].input.destruct();

                        },
                        methods: {
                            preInitialize:function(params)
                            {

                                this.description="";
                                this.hasGlobalErrors = false;
                                this.Dictionary$preInitialize(params);
                                this.globalErrors = [];


                            },
                            getGroups:function()
                            {
                                var groups=this.type.getGroups();
                                if(groups==null)
                                {
                                    return {"DEFAULT":{"LABEL":"Default","FIELDS":this.type.getKeys()}};
                                }
                                return groups;
                            },

                            showPath:function(path)
                            {
                                // Un container, en un showPath, no deberia hacer nada...Ya que siempre muestra todos sus campos..
                            }
                        }
                    },

                ByFieldContainer:{
                    // El Container por campos, no muestra todos los campos a la vez, sino que
                    // permite añadir o quitar campos disponibles.
                    inherits:"Container",
                    methods:{
                        preInitialize:function(params)
                        {
                            /* Se van a utilizar 2 variables aqui, para mantener los campos usados, y los no usados.
                            Los campos no usados, van a ser un SOURCE para un tipo String, que se va a mostrar en un combo.
                            Los campos usados, se van a leer desde un sivLoop.
                            Lo que queremos, es que no haya que hacer otra cosa que manejar esos dos arrays, insertando o eliminando
                            elementos de cada uno.
                            El array para el sivLoop lo puede mantener el widget. El sivloop añade listeners a este mismo array.
                            Pero no pasa lo mismo con el SOURCE. El SOURCE de un campo, tiene que montar un Proxy sobre el array, y
                            ese proxy se lo queda el SOURCE. es decir, en el código siguiente, el ArraySource no se va a quedar con
                            el array "unusedFields", sino que va a hacer un Proxy sobre él. Es sobre ese Proxy sobre el que hay
                            que añadir o quitar elementos. Y es por eso que, una vez creado el tipo (y por tanto, el SOURCE, y su proxy,
                            recuperamos el array (proxy) del SOURCE, y es a ese al que añadimos y borramos elementos */

                            var t=params.type;
                            this.changing=false;
                            this.currentElement=-1;
                            var def=t.getDefinition();
                            var v=t.getValue();
                            var unusedFields=[];
                            this.usedFields=[];
                            for(var k in def["FIELDS"])
                            {
                                if(v===null || Siviglia.empty(v[k]))
                                    unusedFields.push(k);
                                else
                                    this.usedFields.push(k);
                                def["FIELDS"][k]["KEEP_KEY_ON_EMPTY"]=false;
                            }
                            this.fieldsController=Siviglia.types.TypeFactory.getType("controller", {
                                "TYPE": "String",
                                "SOURCE": {
                                    "TYPE": "Array",
                                    "VALUES": unusedFields,
                                    "LABEL": "LABEL",
                                    "VALUE": "LABEL"
                                }
                            },null,null);

                            this.Container$preInitialize(params);

                        },
                        initialize:function(params)
                        {
                            this.Container$initialize(params);
                            var factory=new Siviglia.inputs.jqwidgets.Factory()
                            factory.getInput(this.fieldsController,{controller:this},this.form).then(function(instance){
                                this.fControllerInput=instance;
                                this.fControllerNode.append(instance.rootNode);
                                this.fieldsController.addListener("CHANGE",this,"onFieldAdded");
                                // Recuperamos el array (proxy).
                                this.unusedFields=this.fieldsController.getDefinition().SOURCE.VALUES;
                            }.bind(this));


                        },
                        onFieldAdded:function(evName,params)
                        {
                            // Hay que evitar bucles
                            if(this.changing)
                                return;
                            this.changing=true;
                            var selected=this.fieldsController.getValue();
                            if(selected==null)
                                return;
                            var idx=this.unusedFields.indexOf(selected);
                            if(idx>=0)
                            {
                                this.unusedFields.splice(idx,1);
                                this.usedFields.push(selected);
                            }
                            this.currentElement=selected;
                            this.changing=false;

                        },
                        setCurrent:function(node,params)
                        {
                            this.currentElement=params.current;
                        },
                        removeField:function(node,params)
                        {
                            var selected=params.current;
                            if(selected==null)
                                return;

                            if(selected===this.currentElement) {
                                // Importante destruir primero el subwidget, de forma que destruimos los listeners que
                                // habia sobre los elementos que ahora vamos a destruir. Si no, ese subwidget puede
                                // quedarse apuntando a un valor que ahora vamos a poner a null.

                                this.subwidgets[selected].destruct();
                                this.currentElement = '-1';
                            }
                            var idx=this.usedFields.indexOf(selected);
                            if(idx>=0)
                            {
                                this.usedFields.splice(idx,1);
                                this.unusedFields.push(selected);
                                this.type[selected]=null;
                            }

                        }
                    }
                },
                GridContainer:{
                    inherits:"Container"
                },
                MenuContainer:{
                    inherits:"Container",
                    methods: {
                        preInitialize: function (params) {
                            this.Container$preInitialize(params);
                            this.menu = params["MENU"];
                            this.self = this;
                        },
                        initialize: function (params) {

                            this.menuNode.jqxMenu({
                                    width: '100%', height:"100%"
                                    /* width: '600', height:"30px" */
                            });
                            this.menuNode.css({ 'visibility':'visible'});

                        }
                    }


                },
                Menu:{
                    inherits:"Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",
                    methods: {
                        preInitialize: function (params) {
                            this.controller = params.controller;
                            this.menu = params.menu;
                        },
                        initialize: function () {
                        },
                        getSubMenu: function (node, params) {
                            var label = params.spec.Label;
                            node.attr("href","#");
                            node.html(params.spec.Label);
                            switch (params.spec.Type) {
                                case "Menu": {
                                    var menuWidget = new Siviglia.inputs.jqwidgets.Menu('Siviglia.inputs.jqwidgets.Menu',
                                        {controller: this.controller, menu: params.spec.Menu},
                                        {},
                                        $('<div></div>'),
                                        this.__context
                                    );
                                    menuWidget.__build().then(function (instance) {
                                        node.parent().append(menuWidget.rootNode);
                                    })
                                }
                                    break;
                            }

                        }
                    }

                },
                Array:
                    {
                        inherits:'BaseInput',
                        destruct:function()
                        {
                            if(this.newItemSelector)
                                this.newItemSelector.destruct();
                            if(this.newInstance)
                                this.newInstance.destruct();
                            if(this.currentItem)
                            {
                                this.currentItem.destruct();
                            }
                            this.currentSelection=null;
                        },
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    this.BaseInput$preInitialize(params);
                                    this.value=params.type.getValue()
                                    this.newInstance=null;
                                    this.hasSimpleType=this.type.areContentsSimple();
                                    this.changing=false;
                                    this.currentItem=null;
                                },
                                initialize:function(params)
                                {
                                    if(this.hasSimpleType)
                                        this.buildNewItemWidget();
                                },
                                showPath:function(key)
                                {
                                    this.waitComplete().then(function(){
                                    // Se hace una copia propia
                                    if(typeof this.subWidgets[key]==="undefined")
                                        this.setSelected(key);

                                    }.bind(this));
                                },
                                onRemoveClicked:function(node,params)
                                {
                                    this.type.splice(params.key,1);
                                },
                                buildNewItemWidget:function(node,params)
                                {
                                    this.newInstance=this.type.getValueInstance();
                                    var factory=new Siviglia.inputs.jqwidgets.Factory();
                                    factory.getInput(this.newInstance,{},this.form).then(function(instance){
                                        if(this.newItemSelector) {
                                            this.newItemSelector.destruct();
                                        }
                                        this.newItemNode.html("");
                                      this.newItemSelector =instance;
                                        this.newItemNode.append(this.newItemSelector.rootNode);
                                    }.bind(this));
                                },
                                onRemoveItem:function(node,params)
                                {
                                    var idx=params.index;
                                    var v=this.type.getValue();
                                    v.splice(idx,1);
                                },
                                // Sobreescrito para evitar la llamada a la clase base.
                                onTypeChanged:function()
                                {

                                },
                                onNewItem:function()
                                {

                                    var curVal=this.type.getValue();
                                    if(this.hasSimpleType) {
                                        this.newItemSelector.changing=true;
                                        this.newInstance.setValue(this.newItemSelector.inputNode.val());
                                        if (!this.newInstance.__isEmpty()) {
                                            var newValue=this.newInstance.getValue();
                                            if(curVal===null)
                                                this.type.setValue([newValue]);
                                            else
                                                this.type.getValue().push(newValue);
                                        }

                                        this.newItemSelector.inputNode.val("");
                                        this.newItemSelector.changing=false;
                                        this.newItemSelector.inputNode.focus();
                                    }
                                    else
                                    {
                                        if(curVal===null)
                                            this.type.setValue([null]);
                                        else
                                            this.type.getValue().push(null);
                                        this.setSelected(this.type.getValue().length-1);
                                    }
                                },
                                getInputFor: function (node, params) {
                                    this.setSelected(params.key)
                                },
                                setSelected:function(idx)
                                {
                                    if(idx==this.currentSelection)
                                        return;
                                    if(this.currentItem) {
                                        this.currentItem.destruct();
                                        this.currentItemNode.html("");
                                    }

                                    // Eliminacion de clases con dicho valor "array_selected"
                                    var elements_with_selected = document.getElementsByClassName("array_selected");
                                    for (var i=0; i<elements_with_selected.length; i++) {
                                        elements_with_selected[i].classList.remove("array_selected");
                                    }

                                    // insertamos el clase "array_selected" en el nodo adecuado.
                                    this.currentItemNode[0].previousElementSibling.children[idx*2].classList.add("array_selected");

                                    this.currentSelection=idx;
                                    instance=new Siviglia.inputs.jqwidgets.SimpleInputContainer(
                                      "Siviglia.inputs.jqwidgets.SimpleInputContainer",
                                        {controller:this,form:this.form,key:idx,parent:this.type},
                                        {},
                                        $("<div></div>"),
                                        new Siviglia.Path.ContextStack()
                                    );
                                    instance.__build().then(function(){
                                        this.currentItem=instance;
                                        this.currentItemNode.append(this.currentItem.rootNode);
                                    }.bind(this));
                                }
                            }
                    },
                TypeSwitcher: {
                    inherits: 'BaseInput',
                    destruct:function()
                    {
                        if(this.typeSelector)
                            this.typeSelector.destruct();
                        if(this.typeSelectorWidget)
                            this.typeSelectorWidget.destruct();
                        if(this.subNode)
                            this.subNode.destruct();
                    },
                    methods:
                        {
                        preInitialize:function(params){
                            this.BaseInput$preInitialize(params);
                            this.subNode = null;
                            this.currentType = null;
                            // Se crea el objeto enum que son los tipos permitidos.
                            var allTypes=params.type.getAllowedTypes();
                            var data=[];
                            for(var k in allTypes)
                                data.push({"LABEL":k,"VALUE":k});
                            var source= {
                                "TYPE": "Array",
                                "DATA":data,
                                "LABEL":"LABEL",
                                "VALUE":"VALUE"
                            };

                            var currentType=params.type.getCurrentAllowedType();

                            this.typeSelector=Siviglia.types.TypeFactory.getType ({fieldName:"selector",fieldPath:"/"}, {
                                "TYPE":"String",
                                "SOURCE":source
                            }, null,currentType);

                        },

                        initialize:function(params)
                        {

                            var factory=new Siviglia.inputs.jqwidgets.Factory();


                            factory.getInput(this.typeSelector,{controller:this},this.form).then(
                                function(instance){
                                    this.detach();
                                    this.typeSelectorWidget =instance;
                                    var m=this;
                                    this.typeSelector.addListener("CHANGE",function(event,params){
                                        var val=m.typeSelector.getValue();
                                        m.type.setCurrentType(val);
                                        m.buildTypeUI();
                                    })

                                    this.typeSwitchSelector.append(this.typeSelectorWidget.rootNode);
                                    this.buildTypeUI();
                            }.bind(this))
                        },
                            detach:function()
                            {

                                if(this.typeSelector!==null) {
                                    this.typeSelector.removeListeners(this);

                                }
                            },
                            buildTypeUI:function()
                            {
                                var factory=new Siviglia.inputs.jqwidgets.Factory()

                                this._curType=this.type.getCurrentType();

                                if(this._curType) {
                                    var curTypeObj=this.type.getCurrentTypeObj();
                                    factory.getInput(curTypeObj, {controller: this},this.form).then(function(instance){
                                        if(this.subNode) {
                                            this.subNode.destruct();
                                            this.fieldContainer.html("");
                                        }

                                        this.fieldContainer.append(instance.rootNode);
                                        this.subNode=instance;
                                    }.bind(this));

                                }

                            },
                            showPath:function(path)
                            {
                                // Un TypeSwitcher no tendria por que hacer nada en showPath
                            },
                        getTypeFromValue:function(val)
                        {
                            var typeField = Siviglia.issetOr(this.definition.TYPE_FIELD,null);
                            if(typeField!=null)
                                return val[typeField];;

                            for(var ss in this.definition.TYPE_TYPE)
                            {
                                if(val.constructor.toString().match(ss)==ss)
                                    return this.definition.TYPE_TYPE[ss].TYPE;
                            }
                        },
                            _setInputValue:function(toSet)
                            {

                            },
                        getValue: function () {
                            if (this.subNode)
                                return this.subNode.getValue();
                            return null;
                        },
                        save: function () {
                            if (this.subNode)
                                return this.subNode.save();
                            return null;
                        },
                        setType: function (typeName) {
                            if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                var c = {};
                                c[this.definition.TYPE_FIELD] = typeName;
                            }
                            this.setValue(c);
                        },
                        getAllowedTypes: function () {
                            var result = [];
                            if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                for (var k = 0; k < this.definition.ALLOWED_TYPES.length; k++) {
                                    var n = this.definition.ALLOWED_TYPES[k];
                                    result.push({LABEL: n, VALUE: n});
                                }
                            }
                            else
                            {
                                for(var ss in this.definition.TYPE_TYPE)
                                {
                                    var cc=this.definition.TYPE_TYPE[ss];
                                    result.push({name:cc.LABEL,value:cc.TYPE});
                                }
                            }
                            return result;
                        },
                        getCurrentType: function () {
                            if (Siviglia.isset(this.receivedValue)) {
                                if(Siviglia.isset(this.definition.TYPE_FIELD)) {
                                    var typeField = this.definition.TYPE_FIELD;
                                    return this.receivedValue[typeField];
                                }
                                else
                                {
                                    for(var ss in this.definition.TYPE_TYPE)
                                    {
                                        var cc=this.definition.TYPE_TYPE[ss];
                                        if(this.receivedValue.constructor.toString().match(ss) != null)
                                            return cc.TYPE;
                                    }
                                }
                            }
                            return this.currentType;
                        },
                        getSubNode: function () {
                            return this.subNode;
                        },
                        __getCurrentPath: function (obj) {
                            if (this.parent == null)return '/ROOT';
                            return this.parent.__getCurrentPath(this);
                        }
                    }

                },
                NewItem:
                    {
                        inherits:"Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",
                        destruct:function(){
                            if(this.subInput) {
                                this.subInput.destruct();
                            }
                        },
                        methods:
                            {
                                preInitialize:function(params)
                                {
                                    var typeDefinition={
                                        "TYPE":"String"
                                    };
                                    if(Siviglia.isset(params.type.__definition.SOURCE))
                                        typeDefinition["SOURCE"]=params.type.__definition.SOURCE;

                                    // Sea el tipo que sea el que nos llega, lo convertimos a una String.
                                    typeDefinition["TYPE"]="String";

                                    this.type=Siviglia.types.TypeFactory.getType({fieldName:"selector",fieldPath:"/"}, typeDefinition,null,null);
                                    this.parentInput=params.parentInput;
                                    this.subInput=null;
                                    this.params=params;
                                },
                                initialize:function()
                                {
                                    //this.type.addListener("CHANGE",this,"paintInput");
                                    this.paintInput(null);
                                },
                                detach:function()
                                {
                                    this.type.removeListeners(this);
                                    this.type.destruct();
                                },
                                paintInput:function(data)
                                {
                                    if(this.subInput!==null)
                                    {
                                        this.type=null;
                                    }
                                    else {
                                        var factory = new Siviglia.inputs.jqwidgets.Factory();

                                        factory.getInput(this.type, {controller: this}, this.form).then(function (instance) {
                                            this.subInput = instance;
                                            this.inputNode.html('');
                                            this.inputNode.append(this.subInput.rootNode);
                                        }.bind(this));
                                    }
                                },
                                onAdd: function () {
                                    this.type.setValue(this.inputNode.val());
                                    this.type.save();

                                    this.parentInput.onAdd(this.subInput.getValue());
                                    this.subInput.inputNode.val(null);

                                }
                            }
                    },
                SimpleInputContainer:{
                    inherits:"Siviglia.UI.Expando.View",
                    destruct:function()
                    {
                        if(this.innerInput!==null)
                            this.innerInput.destruct();
                        this.rootNode.html("");
                        if(this.controller!==null)
                            this.controller.removeSubWidget(this.field,this);
                        this.form.unregisterInput(this);
                    },
                    methods:
                        {
                            preInitialize:function(params)
                            {
                                this.form=params.form;
                                this.innerInput=null;
                                this.controller=null;
                                // parent se refiere al parent type
                                this.parent=params.parent;
                                this.field=params.key;
                                // controller se refiere al input o form que contiene este inputContainer
                                this.controller=typeof params.controller==="undefined"?this.form:params.controller;
                                if(typeof this.parent.getPath!=="undefined")
                                    this.innerType=this.parent.getPath("#*"+this.field);
                                else
                                    this.innerType=this.parent["*"+this.field];


                                this.fieldName=params.key;
                                this.fieldDef=this.innerType.getDefinition();
                                this.innerInput=null;
                                this.pathToShow=null;
                                this.form.registerInput(this,this.innerType);


                            },
                            initialize:function()
                            {
                                if(this.controller)
                                    this.controller.addSubWidget(this.field,this);

                                else
                                this.rootNode.addClass(this.fieldName);
                                var typeDef=this.innerType.getDefinition();
                                this.rootNode.addClass(typeDef["TYPE"]);

                                this.inputNode.addClass(this.fieldName);
                            },
                            focus:function()
                            {
                                this.rootNode[0].scrollIntoView();
                            },
                            showPath:function(key)
                            {

                                    if(this.innerInput)
                                        this.innerInput.showPath(key);
                                    else
                                        this.pathToShow=key;

                            },
                            getInputFor:function(node,params)
                            {
                                var factory=new Siviglia.inputs.jqwidgets.Factory()
                                //this.curType=this.type.getField(key);
                                return factory.getInput(this.innerType,{controller:this,inputWrapper:this},this.form).then(
                                    function(instance){
                                        if(this.innerInput!=null) {
                                            this.innerInput.destruct();
                                            this.inputNode.html("");
                                        }
                                        this.innerInput=instance;
                                        //this.innerInput.setInputWrapper(this);
                                        if (typeof instance.inputWrapper.rootNode[0].children[3] !== "undefined")
                                            this.errorNode=instance.inputWrapper.rootNode[0].children[3].children[0];

                                        this.inputNode.append(instance.rootNode);
                                        /*var ce=this.currentErrors[key]
                                        if(ce) {
                                            for(var k=0;k<ce.length;k++) {
                                                instance.addError(ce[k].path, ce[k].error);
                                            }
                                        }
                                        delete this.currentErrors[key];*/
                                        if(this.pathToShow!==null)
                                            instance.showPath(this.pathToShow);
                                        this.pathToShow=null;

                                    }.bind(this));
                            },
                            getInner:function()
                            {
                                return this.innerInput;
                            },
                            clearErrors:function()
                            {
                                this.innerInput.clearErrors();
                            },
                            showError:function(e)
                            {
                                this.innerInput.showError(e);
                            }

                        }
                },
                StdInputContainer:{
                    inherits:"SimpleInputContainer",
                    methods:
                        {
                            preInitialize:function(params)
                            {
                                this.SimpleInputContainer$preInitialize(params);
                                // SI NO HAY AYUDA, LO QUE HAY QUE HACER, ES OCULTAR EL DIV
                                // QUE TIENE LA AYUDA. PARA HACER ESO, SE LE PONE UN SIVID , Y
                                // EN INITIALIZE, SE LE OCULTA.
                                this.help=Siviglia.issetOr(this.fieldDef["HELP"],"");
                                this.label=Siviglia.issetOr(this.fieldDef["LABEL"],"");
                                this.errorNode="";
                            },
                            initialize:function(params)
                            {
                                this.SimpleInputContainer$initialize(params);

                                this.labelNode.addClass(this.fieldName);
                                // SI NO HAY AYUDA, LO QUE HAY QUE HACER, ES OCULTAR EL DIV
                                // QUE TIENE LA AYUDA. PARA HACER ESO, SE LE PONE UN SIVID , Y
                                // EN INITIALIZE, SE LE OCULTA.
                                if (this.help === ""){
                                    this.helpNode.addClass("hidden-help");
                                }
                                if(this.innerType.__isRequired()){
                                    this.requiredNode.addClass("required");
                                }else{
                                    // para forzar a no mostrar el div del nodo ni siquiera
                                    this.requiredNode[0].style.display = "none";
                                }
                            }
                        }
                },
                StdFormButtons:{
                    inherits:"Siviglia.UI.Expando.View",
                    methods:
                        {
                            preInitialize:function(params)
                            {

                                this.form=params.form;
                                if(typeof params.button === "undefined")
                                    this.buttons=[{"label":"Ok","callback":"submit","class":"button-ok"}];
                                else
                                    this.buttons=params.buttons;

                            },
                            initialize:function()
                            {
                                for(var k=0;k<this.buttons.length;k++)
                                {
                                    var cs=this.buttons[k];
                                    var curB=$('<input type="button" value="'+cs.label+'">');
                                    (function(cs,curB,form){
                                    curB.on("click",function(){form[cs["callback"]]();}.bind(this));
                                    if(typeof cs.class!=="undefined")
                                        curB.addClass(cs.class);
                                    })(cs,curB,this.form);
                                    this.buttonContainer.append(curB);
                                }
                            },
                            onclick:function(node, params)
                            {
                                this.form.submit();
                            }
                        }

                },
                Form:{
                    inherits:"Container",
                    destruct:function()
                    {
                        if(this._type)
                            this._type.destruct();
                        if(this.__containerWidget)
                            this.__containerWidget.destruct();
                    },
                    methods:
                        {
                            preInitialize:function(params)
                            {
                                //En los params puede haber o un campo model/form/value , o un bto
                                // Si es un bto, el formulario no esta asociado a un model/form, sino que simplemente se edita
                                // un basetypedobject, cuando, por ejemplo, es un filtro para un datasource, o un test.
                                var loadedPromise = $.Deferred();
                                var containerPromise=$.Deferred();
                                var m=this;
                                this.self=this;
                                this.__model=null;
                                this._type=null;
                                this.registeredInputs=[];
                                this.__erroredInputs={};
                                this.__containerWidget=null;
                                this.__errorNode=null;
                                this.__pathToShow=null;
                                this.__pathToShowMaxMatch=0;
                                if(typeof params.model==="undefined") {
                                    this._type = params.bto;
                                    this.setupBto();
                                    loadedPromise.resolve(this._type);
                                }
                                else {
                                    this.__model = params.model;
                                    this.__formName = params.form;
                                    var descriptor = new Siviglia.Model.ModelDescriptor(params.model);
                                    var formUrl = descriptor.getFormUrl(params.form, params.keys);
                                    var transport = new Siviglia.Model.Transport();

                                    transport.doGet(formUrl).then(function (result) {
                                        if (result.error == 0) {
                                            this._type = new Siviglia.Model.Form(params.model, params.name, params.keys, result.form.definition, result.form.value);
                                            this.setupBto();
                                            loadedPromise.resolve(this._type);

                                        } else
                                            loadedPromise.reject();
                                    }.bind(this))
                                }
                                $.when(loadedPromise).then(function(bto){
                                    this.onLoaded(bto);

                                    containerPromise.resolve();
                                }.bind(this));
                                return containerPromise;
                            },
                            onLoaded:function(bto)
                            {
                                this.Container$preInitialize({type:bto,form:this});
                                this._form=this;
                            },
                            setupBto:function()
                            {

                                var ip = Siviglia.issetOr(this._type.__definition.INPUTPARAMS, {});
                                this.__ip = [];
                                for (var k in ip) {
                                    var t = k.replace(/\+/gm, '.*')
                                    t = t.replace(/\*/gm, '[^/]*');
                                    t = t.replace(/\//, '\\/');
                                    var r = new RegExp("^" + t + "$");
                                    this.__ip.push({reg: r, ip: ip[k]});
                                }
                            },
                            getFormParams:function(typePath)
                            {
                                var curP={};
                                this.__ip.map(function(item){
                                    if(typePath.match(item.reg))
                                        curP=Siviglia.deepmerge(curP,item.ip);
                                })
                                return curP;
                            },
                            appendError:function(path,input)
                            {
                                this.__erroredInputs[path]=input;
                            },
                            clearError:function(path,input)
                            {
                                if(typeof this.__erroredInputs[path]!=="undefined")
                                    delete this.__erroredInputs[path];
                            },
                            submit: function () {
                                var errors=[];
                                if(this.hasGlobalErrors)
                                {
                                    this.hasGlobalErrors=false;
                                    if(this.__errorNode!==null)
                                        this.__errorNode.css({'display':'none'});
                                }

                                    for(var k=0;k<this.registeredInputs.length;k++) {
                                        try{

                                            this.registeredInputs[k].input.getInner().save();
                                            this.registeredInputs[k].input.clearErrors();
                                        }catch(e)
                                        {
                                            errors.push(e);
                                            this.registeredInputs[k].input.showError(
                                                Siviglia.i18n.es.base.getErrorFromJsException(e)
                                            );
                                        }

                                    }

                                    try{
                                        this._type.save()
                                    }catch(e)
                                    {
                                        errors.push(e);
                                    }
                                if (errors.length >0) {
                                    for (var k=0;k<errors.length;k++) {
                                        if(!errors[k].path)
                                        {
                                            console.error("ERROR DURANTE SAVE:"+errors[k].toString());
                                        }

                                        var path = errors[k].path.split("/");
                                        path.shift();
                                        this.showPath("/"+path.join("/"));
                                    }
                                    return;
                                }
                                var i = Siviglia.issetOr(this.type.getDefinition().INDEXFIELDS,null);

                                var myIndexes = {};
                                var vals = this._type.getPlainValue();
                                if(i!=null) {
                                    for (var k = 0; k < i.length; k++) {
                                        if (!this.type["*" + i[k]].__isEmpty()) {
                                            myIndexes[i[k]] = this._type[i[k]];
                                        } else {
                                            myIndexes = null;
                                        }
                                        delete vals[i[k]];
                                    }
                                }
                                return this.onSubmit(myIndexes,vals);
                            },
                            doRedirect:function(type)
                            {
                                if(typeof this._type.__definition["REDIRECT"]!=="undefined" &&
                                    typeof this._type.__definition["REDIRECT"][type]!=="undefined" &&
                                    this._type.__definition["REDIRECT"][type]!==""
                                ) {
                                    var url=this._type.__definition["REDIRECT"][type];
                                    setTimeout(function(){window.location.assign(url);},200);
                                    return true;
                                }
                                return false;

                            },
                            registerInput:function(input,type)
                            {
                                this.registeredInputs.push({input:input,type:type});
                                if(this.__pathToShow!==null) {
                                    var spliced = type.__fieldNamePath.split("/");
                                    if(spliced[0]==="")
                                        spliced.shift();
                                    var n=0;
                                    while(n<this.__pathToShow.length && spliced[n]==this.__pathToShow[n])
                                        n++;

                                    if(n > this.__pathToShowMaxMatch)
                                    {
                                        if(n===this.__pathToShow.length) {
                                            input.focus();
                                            this.__pathToShow=null;
                                        }
                                        else
                                        {
                                            this.__pathToShowMaxMatch=n;
                                            input.showPath(this.__pathToShow[n]);
                                        }
                                    }
                                }
                            },
                            unregisterInput:function(input)
                            {
                                for(var k=0;k<this.registeredInputs.length;k++)
                                {
                                    if(this.registeredInputs[k].input===input)
                                        this.registeredInputs.splice(k,1);
                                }
                            },
                            // A diferencia del resto de metodos showPath, en este caso, el path es una string.
                            showPath:function(path)
                            {
                                // Hay que encontrar el widget con el path minimo al error.
                                // Es decir, si el path es /a/b/c , tenemos que encontrar, si es posible, el input
                                // asociado a /a , si no, a /a/b, y si no, el propio /a/b/c. Esto es necesario
                                // para que se expandan los containers, en caso de que el error este en un input oculto.
                                // Para encontrar ese minimo path, se reconstruye el path del error, y se hace un replace
                                // de ese path, en el path de cada tipo, con "". La cadena minima resultante, es el input
                                // que buscamos.
                                this.waitComplete().then(function(){
                                var rPath=path;
                                var splicedPath=path.split("/");
                                splicedPath.shift();
                                var maxlen=-1;
                                var maxVal=null;
                                var erroredInput=null;
                                for(var k=0;k<this.registeredInputs.length;k++)
                                {
                                    var fpath=this.registeredInputs[k].type.__fieldNamePath;
                                    // Si el path del campo esta al principio del path del error
                                    if(rPath.indexOf(fpath)===0)
                                    {
                                        // Buscamos la longitud del match
                                        var curLen=rPath.replace(fpath,"").length;
                                        if(maxlen==-1 || curLen > maxlen)
                                        {
                                            maxlen=curLen;
                                            maxVal=this.registeredInputs[k];
                                        }
                                        // Si los paths son los mismos, es que hemos encontrado el nodo que esta
                                        // incorrecto. Lo guardamos, para hacer scroll a el, por si no estaba a la vista.
                                        if(curLen===0)
                                        {
                                            erroredInput=this.registeredInputs[k];
                                        }
                                    }
                                }

                                // Ahora en minIndex tenemos el input con el indice minimo.
                                // Pero queda aun un paso: hay que enviarle el path *a partir de el*, o sea,
                                // si el error estaba en /a/b/c  y hemos encontrado /a/b, el path que le enviamos debe ser sólo "c"
                                if(maxlen >= 0)
                                {
                                    var found=maxVal.type.__fieldNamePath.split("/");
                                    if(found[0]=="")
                                        found.shift();
                                    this.__pathToShow=splicedPath;
                                    this.__pathToShowMaxMatch=found.length;
                                    maxVal.input.showPath(splicedPath[found.length]);
                                }
                                else
                                {
                                    // No se ha encontrado ningun input...Lo sacamos por consola
                                    console.error("Form: Path not found in showPath: "+path);
                                }
                                }.bind(this));
                            },
                            onSubmit:function(indexes,vals)
                            {
                                this.globalErrors=[];
                                this.hasGlobalErrors=false;
                                var p=$.Deferred();
                                if(this.__model===null) {
                                    p.resolve();
                                }
                                else
                                    {
                                    Siviglia.Model.loader.doAction(indexes, vals, this.__model, this.__formName).then(
                                        function (r) {
                                            if (r.error == 0) {
                                                //this.type.setValue(r.data[0]);
						                        var returned=r.data!==null?r.data[0]:null;
                                                this.onSuccess(returned);
                                                if(!this.doRedirect("ON_SUCCESS"))
                                                    p.resolve(r);
                                            } else {
                                                this.parseErrors(r)
                                                this.onError(r);
                                                if (!this.doRedirect("ON_ERROR"))
                                                    p.reject(r);
                                            }
                                        }.bind(this),
                                        function (error) {
                                            this.parseErrors(error)
                                            if(!this.doRedirect("ON_ERROR"))
                                                p.reject(error)
                                        }.bind(this)
                                    )
                                }
                                return p;
                            },
                            onSuccess:function(data)
                            {

                            },
                            onError:function(errors)
                            {

                            },
                            parseErrors:function(e)
                            {
                                if (e.error == 1) {
                                    var nFieldErrors=0;
                                    if (e.action.fieldErrors) {
                                        for (var k in e.action.fieldErrors) {
                                                for (var c in e.action.fieldErrors[k]) {
                                                    for(h in e.action.fieldErrors[k][c]) {
                                                        var error = e.action.fieldErrors[k][c][h];
                                                        var parts=error.path.split("/");
                                                        if (parts[0] == "")
                                                            parts.shift();
                                                        this.addError(parts, error);
                                                    }
                                                }
                                        }
                                    }
                                    var isArray=toString.call(e.action.globalErrors) === "[object Array]";
                                    if (e.action.globalErrors && !isArray)
                                    {
                                        this.decodeGlobalServerErrors(e.action.globalErrors)
                                    }
                                }
                                else
                                {
                                    if(e.message)
                                        this.fireEvent("GENERAL_ERROR",e.message + e.response.text);
                                }
                            },
                            /*

                                NOTA : ESTOS METODOS SE DEJAN AQUI, PERO TENDRAN QUE MOVERSE MUY POSIBLEMENTE
                                A LOS WIDGETS, YA QUE SE DEDICAN A PINTAR
                             */
                            decodeGlobalServerErrors:function(ex)
                            {
                                var messages=[];
                                for(var k in ex)
                                {
                                    var parts= k.split("::");
                                    var exName=parts[1];
                                    var message='';
                                    if (typeof this.type.__definition.ERRORS !== "undefined" &&
                                        typeof this.type.__definition.ERRORS["GLOBAL"] !== "undefined" &&
                                        typeof this.type.__definition.ERRORS["GLOBAL"][exName] !== "undefined")
                                        messages.push(this.type.__definition.ERRORS["GLOBAL"][exName]["txt"]);
                                    else {
                                        messages.push(Siviglia.issetOr(ex[k]["str"],exName));
                                    }
                                }
                                if(messages.length>0) {
                                    this.globalErrors = messages;
                                    this.hasGlobalErrors = true;

                                    if(this.__errorNode!==null) {
                                        this.__errorNode.html("");
                                        var ul=$("<ul></ul>");
                                        for(var j=0;j<this.globalErrors.length;j++)
                                        {
                                            var li=$("<li>"+this.globalErrors[j]+"</li>");
                                            ul.append(li);
                                        }
                                        this.__errorNode.append(ul);
                                        this.__errorNode.css({'display': 'block'});
                                    }

                                }
                            },
                            decodeServerError: function (field, exception) {
                                this[field].clearErrors();
                                var exName="";
                                for(var k in exception)
                                    exName=k;
                                var errDef=this.type.__definition.FIELDS[field]["ERRORS"];
                                if(!errDef)
                                {
                                    var h;
                                    if((h=this.type.__definition.ERRORS) && (h= h.FIELDS) && (h=h[field]))
                                    {
                                        errDef=h;
                                    }
                                }
                                if(errDef && errDef[k])
                                    return errDef[k]["txt"];


                                var msg = Siviglia.i18n.es.base.getErrorFromServerException(k, exception[k]);
                                if (msg) {
                                    return msg;
                                }
                                return "Unknown error";
                            }
                        }
                },
                Confirm:{
                    inherits: "Siviglia.UI.Expando.View,Siviglia.Dom.EventManager",
                    destruct:function()
                    {
                        this.rootNode.jqxWindow('destroy');
                    },
                    methods:{
                        preInitialize:function(params)
                        {
                            this.title=params.title;
                            this.message=params.message;
                        },
                        initialize:function(params)
                        {
                            this.rootNode.jqxWindow({
                                height: 100, //'auto',
                                width: 350,
                                autoOpen: false,
                                isModal: true,
                                okButton: this.buttonYes,
                                cancelButton: this.buttonNo,
                                initContent: function () {
                                    this.buttonYes.jqxButton({ width: 40, height: 30 });
                                    this.buttonNo.jqxButton({ width: 40, height: 30 });
                                    this.buttonNo.focus();

                                    this.buttonYes.click(function () {
                                        this.fireEvent("CONFIRM",{"value":true});
                                    }.bind(this));
                                    this.buttonNo.click(function(){
                                        this.fireEvent("CONFIRM",{"value":false});
                                    }.bind(this))
                                }.bind(this)
                            });
                        },
                        open:function()
                        {
                            this.rootNode.jqxWindow('open');
                            this.rootNode.jqxWindow('focus');
                        }
                    }
                }
            }
        }
    )


</script>

<div style="display:none">
    <div data-sivWidget="Siviglia.inputs.jqwidgets.AutoIncrement" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.AutoIncrement">
        <input type="text" class="form-control AutoIncrementInput" data-sivId="inputNode"></input>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.String" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.String">
         <input type="text" placeholder="" class="form-control StringInput" data-sivId="inputNode">
    </div>

    <div data-sivWidget="Siviglia.inputs.jqwidgets.Enum" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Enum">
        <div data-sivId="inputNode" class="form-control EnumInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Integer" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Integer">
        <div data-sivId="inputNode" class="form-control IntegerInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Decimal" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Decimal">
        <div data-sivId="inputNode" class="form-control DecimalInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Text" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Text">
        <input type="text" class="form-control TextInput" data-sivId="inputNode"></input>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Boolean" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Boolean">
        <div data-sivId="inputNode" class="form-control BooleanInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Date" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Date">
        <div data-sivId="inputNode" class="form-control DateInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.DateTime" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.DateTime">
        <div data-sivId="inputNode" class="form-control DateTimeInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.ComboBox" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.ComboBox">
        <div data-sivId="inputNode" class="form-control ComboBoxInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.BooleanCombo" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.BooleanCombo">
        <div data-sivId="inputNode" class="form-control BooleanComboInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.FixedSelect" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.FixedSelect">
        <div data-sivId="inputNode" class="form-control FixedSelectInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Relationship" data-widgetParams="type,inputParams,sourceParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Relationship">
        <div data-sivId="inputNode" class="form-control RelationshipInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Date" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Date">
        <div data-sivId="inputNode" class="form-control DateInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Money" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Money">
        <div data-sivId="inputNode" class="form-control MoneyInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Password" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Password">
        <input type="password" class="form-control PasswordInput" data-sivId="inputNode"></input>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.State" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.State">
        <div data-sivId="inputNode" class="form-control StateInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Name" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Name">
        <div data-sivId="inputNode" class="form-control NameInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Street" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Street">
        <div data-sivId="inputNode" class="form-control StreetInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.City" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.City">
        <div data-sivId="inputNode" class="form-control CityInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Phone" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Phone">
        <div data-sivId="inputNode" class="form-control PhoneInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.UUID" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.UUID">
        <div data-sivId="inputNode" class="form-control UUIDInput"></div>
    </div>
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Model" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Model">
        <div data-sivId="inputNode" class="form-control ComboBoxInput"></div>
    </div>

    <div data-sivWidget="Siviglia.inputs.jqwidgets.Dictionary" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.Dictionary">
        <div class="DictionaryInput ContainerInput">

                <div class="Dictionary-heading" data-sivValue="/*title" class="title"></div>
                <div class="Dictionary-body">
                    <p class="text-info description" data-sivValue="/*description"></p>

                    <div data-sivIf="[%/*hasSimpleType%] == false" >

                        <div class="row-form Dictionary-row-complex">
                                <div class="Dictionary-keys">
                                    <div class="Dictionary-mainKeyList">
                                        <!-- añade el boton + -->

                                        <!-- añade las claves introducidas -->
                                        <ul class="Dictionary-row Dictionary-keyList">
                                            <div data-sivLoop="/*type" data-contextIndex="current">
                                                <li class="Dictionary-keylist-item">
                                                    <a class="mainKeyList" data-toggle="pill" href="#/@current-index">
                                                        <span style="display:block"  data-sivValue="title|[%/@current-index%]::[%/@current-index%]"
                                                              data-sivParams='{"key":"/@current-index"}'
                                                              data-sivEvent="click" data-sivCallback="onLabelClicked"></span>
                                                    </a>
                                                    <i class="Dictionary-removeButton" data-sivEvent="click" data-sivCallback="onRemoveClicked" data-sivParams='{"key":"/@current-index"}' data-sivValue="title|Eliminar [%/@current-index%]"></i>
                                                </li>
                                            </div>
                                        </ul>
                                        Añadir:
                                    </div>
                                    <div class="Dictionary-newItemWidget">
                                        <div data-sivView="Siviglia.inputs.jqwidgets.NewItem" data-sivParams='{"parentInput":"/*self","type":"/*type"}'></div>
                                    </div>
                                </div>

                                <!-- contenido añadido en add.html -->
                                <div class="Dictionary-current">
                                    <div data-sivIf="[%/*hasCurrentKey%] == true" style="flex-grow:2">
                                        <div style="display:flex" data-sivId="currentI">
                                            <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"/*currentKey","parent":"/*type","form":"/*form","controller":"/*self"}'>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                    </div>
                    <div data-sivIf="[%/*hasSimpleType%] == true" >
                        <div class="row-form Dictionary-row-complex-simple">
                        <div  data-sivLoop="/*type" data-contextIndex="current">
                            <div style="display:flex">
                                <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"@current","parent":"/*type","form":"/*form","controller":"/*self"}'>
                                </div>
                            </div>


                        </div>
                        <div class="Dictionary-newItemWidget" data-sivCall="buildNewItemWidget"></div>
                    </div>
                    </div>

                </div>

        </div>
    </div>

    <div data-sivWidget="Siviglia.inputs.jqwidgets.Container" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.Container">
        <div class="ContainerInput">

                    <p class="text-info description" data-sivValue="/*description"></p>
                    <div data-sivIf="[%/*hasGlobalErrors%] == true">
                        <div class="globalErrors">
                            <ul class="globalErrorList" sata-sivLoop="/*globalErrors" data-contextIndex="current">
                                <li class="globalError" sivValue="/@current"></li>
                            </ul>
                        </div>
                    </div>
                    <div class="inputs container">
                        <div data-sivLoop="/*type/__definition/FIELDS" data-contextIndex="current">
                            <div>
                            <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"@current-index","parent":"/*type","form":"/*form","controller":"/*self"}'>
                            </div>
                            </div>
                        </div>
                    </div>


        </div>
    </div>
<!--
    ----------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.FlexContainer" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.FlexContainer">
        <div class="ContainerInput FlexContainerInput">
            <div style="display:flex;flex-direction:row;flex-wrap:wrap;justify-content:flex-start" data-sivLoop="/*type/__definition/FIELDS" data-contextIndex="current">
                <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"@current-index","parent":"/*type","form":"/*form","controller":"/*self"}'>
                </div>
            </div>
        </div>
    </div>
<!--
    --------------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.GridContainer" data-widgetParams="type,inputParams" data-widgetCode="Siviglia.inputs.jqwidgets.GridContainer">
        <div class="ContainerInput GridContainerInput">
                <div data-sivLoop="/*type/__definition/FIELDS" data-contextIndex="current">
                    <div class="GridItem">
                        <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"@current-index","parent":"/*type","form":"/*form","controller":"/*self"}'>
                        </div>
                    </div>
                </div>
        </div>
    </div>
<!--
    --------------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Array" data-widgetParams="parentObject,parentNode,value" data-widgetCode="Siviglia.inputs.jqwidgets.Array" class="ArrayType">
    <!--<p class="text-info description" data-sivValue="/*description"></p>-->
        <div class="ArrayInput">
    <div data-sivIf="[%/*hasSimpleType%] == true" >
        <div class="arrayValues">
            <div data-sivLoop="/*type" data-contextIndex="current">
                <span class="arraySimpleValue">
                    <span data-sivValue="title|[%/@current%]::[%/@current%]"></span>
                    <i class="arraySimpleValue-removeButton" data-sivevent="click" data-sivCallback="onRemoveItem" data-sivparams='{"index":"/@current-index"}' data-sivValue="title|Eliminar [%/@current%]"></i>
                </span>
            </div>
        </div>
        <div>
            <div data-sivId="newItemNode"></div>
                <button class="button-add" data-sivId="addSimpleItem" data-sivEvent="click" data-sivCallback="onNewItem">Add</button>
            </div>
        </div>
        <div data-sivIf="[%/*hasSimpleType%] == false" >
            <div style="display:flex;flex-direction:row;flex-wrap:nowrap">
                <div class="arrayContainerComplexValues">
                    <div data-sivLoop="/*type" data-contextIndex="current">
                        <a class="arrayValueComplex" data-sivId="currentArrayNode" data-sivEvent="click" data-sivParams='{"key":"@current-index"}' data-sivCallback="getInputFor" class="label label-primary" data-sivValue="[%/@current-index%]"></a>
                        <span data-sivValue="title|Eliminar [%/@current-index%]" class="arraySimpleValue-removeButton" data-sivEvent="click" data-sivCallback="onRemoveItem" data-sivParams='{"index":"@current-index"}'></span>
                    </div>
                </div>
                <div class="contentRelatedArrayComplex" data-sivId="currentItemNode"></div>
            </div>
            <button class="button-add" data-sivId="addSimpleItem"  data-sivEvent="click" data-sivCallback="onNewItem">Add</button>
        </div>
        </div>
    </div>
<!--
    ------------------------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.TypeSwitcher" data-widgetParams="parentObject,parentNode,value" data-widgetCode="Siviglia.inputs.jqwidgets.TypeSwitcher">
        <div class="TypeSwitcherInput">


                    <div class="TypeSwitcherSelector">
                        <span>Seleccionar Tipo:</span>
                        <span data-sivId="typeSwitchSelector">
                        </span>
                    </div>

                    <div data-sivId="fieldContainer" class="TypeSwitcherField"></div>

        </div>
    </div>
<!--
    ---------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.NewItem" data-widgetParams="parentObject,parentNode" data-widgetCode="Siviglia.inputs.jqwidgets.NewItem">
        <div class="NewItem">
            <div style="display:table-row">
                <div style="display:table-cell" data-sivId="inputNode">
                </div>
                <div style="display:table-cell;vertical-align: top;line-height: 1.0;font-size: 20px;"><div class="NewItem-addButton" data-sivEvent="click" data-sivCallback="onAdd" class="add"></div></div>
            </div>
        </div>
    </div>
<!--
    ---------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.Form" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.Form">
        <div class="Form">
        <div data-sivId="formNode"></div>
        <!-- <div class="formSubmit"></div> -->
        <input class="form-button" type="button" data-sivEvent="click" data-sivCallback="submit" value="Save">
        </div>
    </div>

    <div data-sivWidget="Siviglia.inputs.jqwidgets.FilteringForm" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.FilteringForm">
        <div class="Form FilteringForm">
        <div data-sivId="formNode"></div>
        </div>

    </div>
<!--
    ---
    -->

<!--
    ---------------------------------------------------------------------------------------
-->

    <div data-sivWidget="Siviglia.inputs.jqwidgets.ByFieldContainer" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.ByFieldContainer">
        <div class="ContainerInput ByFieldContainerInput">
            <div style="float:left;border:1px solid black;width:250px">
                <div data-sivId="fControllerNode"></div>
                <div>
                    <div data-sivLoop="*usedFields" data-contextIndex="current">
                        aa
                        <div>
                            <span data-sivValue="[%@current%]" data-sivEvent="click" data-sivCallback="setCurrent" data-sivParams='{"current":"/@current"}'></span>
                            <span style="background-color:red;color:white;padding:2px" data-sivEvent="click" data-sivCallback="removeField" data-sivParams='{"current":"/@current"}'>x</span>
                        </div>
                    </div>
                </div>
            </div>
            <div data-sivIf="'[%/*currentElement%]' != '-1'"  style="float: left; margin-left: 20px;">
                <div>
                    <div data-sivView="Siviglia.inputs.jqwidgets.StdInputContainer" data-sivParams='{"key":"*currentElement","parent":"/*type","form":"/*form","controller":"/*self"}'>
                    </div>
                </div>
            </div>
            </div>
            <div style="clear:both"></div>
        </div>


<!------------------------------------------------------------------------------------------->

<!--
    ---------------------------------------------------------------------------------------
-->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.MenuContainer" data-widgetParams="type,inputParams"
         data-widgetCode="Siviglia.inputs.jqwidgets.MenuContainer">
        <div data-sivId="menuNode">
            <div data-sivView="Siviglia.inputs.jqwidgets.Menu" data-sivParams='{"controller":"*self","menu":"*menu"}'>
            </div>
        </div>
    </div>

<!--
    ---------------------------------------------------------------------------------------
-->

    <div data-sivWidget="Siviglia.inputs.jqwidgets.Menu" data-widgetParams="controller" data-widgetCode="Siviglia.inputs.jqwidgets.Menu">
        <ul style="width:250px">
        <div data-sivLoop="/*menu" data-contextIndex="current" data-sivnested="false">
            <li>
                <a data-sivCall="getSubMenu" data-sivParams='{"spec":"@current"}'></a>
            </li>
        </div>
        </ul>
    </div>

    <!--
            ---------------------------------------------------------------------------------------
            -->
    <div data-sivWidget="Siviglia.inputs.jqwidgets.SimpleInputContainer" data-widgetParams="key,parent,form,controller" data-widgetCode="Siviglia.inputs.jqwidgets.SimpleInputContainer">
        <div class="input" data-sivId="inputNode" data-sivCall="getInputFor" data-sivParams="{}"></div>
    </div>

    <!--
                ---------------------------------------------------------------------------------------
                -->
<div data-sivWidget="Siviglia.inputs.jqwidgets.StdInputContainer" data-widgetParams="key,parent,form,controller" data-widgetCode="Siviglia.inputs.jqwidgets.StdInputContainer">
    <div class="StdInputContainer">

            <div data-sivId="requiredNode" title="Requerido"></div>
            <div data-sivId="labelNode" class="label" data-sivValue="/*label"></div>
            <div data-sivId="helpNode" class="help tooltip">
                <span data-sivValue="/*help" class="tooltiptext"></span>
            </div>

            <div data-sivId="inputNode" class="input" data-sivCall="getInputFor" data-sivParams="{}">
                <span data-sivId="errorNode" class="errorNodetext" style="display: none"></span>
            </div>

            <div style="clear:both"></div>
    </div>
</div>

<div data-sivWidget="Siviglia.inputs.jqwidgets.StdFormButtons" data-widgetParams="form" data-widgetCode="Siviglia.inputs.jqwidgets.StdFormButtons">
    <div class="StdFormButtons">
        <div class="buttonContainer" data-sivId="buttonContainer"></div>
    </div>
</div>

<div data-sivWidget="Siviglia.inputs.jqwidgets.Confirm" data-widgetParams="title,message" data-widgetCode="Siviglia.inputs.jqwidgets.Confirm">
    <div data-sivId="windowContainer" class="ConfirmContainer" style="display:none">
        <div data-sivId="item">
            <div data-sivValue="[%/*title%]"></div>
                <div>
                    <p data-sivValue="[%/*message%]"></p>
                    <br/>
                    <input type="button" value="No" data-sivId="buttonNo" class="ConfirmNo" />
                    <input type="button" value="Yes" data-sivId="buttonYes" class="ConfirmYes"  />
                </div>
            </div>
        </div>
    </div>
</div>